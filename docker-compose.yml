services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile.browser
    image: openclaw-browser:latest
    restart: unless-stopped
    user: "root"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TYPEFULLY_API_KEY: ${TYPEFULLY_API_KEY}
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
      - openclaw_data:/home/node/.openclaw/workspace/data
      - ./config/openclaw.json:/tmp/openclaw-seed.json:ro
      - ./workspace:/tmp/workspace-seed:ro
    init: true
    shm_size: '2gb'
    expose:
      - "18789"
    networks:
      - dokploy-network
    command:
      - sh
      - -c
      - |
        chown -R node:node /home/node/.openclaw &&
        chmod 700 /home/node/.openclaw &&
        cp /tmp/openclaw-seed.json /home/node/.openclaw/openclaw.json &&
        chmod 600 /home/node/.openclaw/openclaw.json &&
        cp -r /tmp/workspace-seed/* /home/node/.openclaw/workspace/ 2>/dev/null;
        mkdir -p /home/node/.openclaw/workspace/data;
        clawhub install typefully --workdir /home/node/.openclaw/workspace 2>/dev/null;
        chromium --headless=new --no-sandbox --disable-gpu --disable-dev-shm-usage --disable-setuid-sandbox --remote-debugging-port=18800 --user-data-dir=/home/node/.openclaw/browser/openclaw about:blank &
        sleep 2 &&
        exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured

  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:latest
    user: "root"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      BROWSER: echo
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    networks:
      - dokploy-network
    entrypoint: ["node", "dist/index.js"]

volumes:
  openclaw_config:
  openclaw_workspace:
  openclaw_data:

networks:
  dokploy-network:
    external: true
