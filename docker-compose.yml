services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile.browser
    image: openclaw-browser:latest
    restart: unless-stopped
    user: "root"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      PLAYWRIGHT_BROWSERS_PATH: /home/node/.cache/ms-playwright
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TYPEFULLY_API_KEY: ${TYPEFULLY_API_KEY}
      TWITTER_BEARER_TOKEN: ${TWITTER_BEARER_TOKEN}
      TWITTER_API_KEY: ${TWITTER_API_KEY}
      TWITTER_API_SECRET: ${TWITTER_API_SECRET}
      APIFY_API_TOKEN: ${APIFY_API_TOKEN}
      X_APIFY_CACHE_DIR: /home/node/.openclaw/workspace/data/.cache/x-apify
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
      - openclaw_data:/home/node/.openclaw/workspace/data
      - ./config/openclaw.json:/tmp/openclaw-seed.json:ro
      - ./workspace:/tmp/workspace-seed:ro
    init: true
    shm_size: "2gb"
    expose:
      - "18789"
    networks:
      - dokploy-network
    command:
      - sh
      - -lc
      - |
        mkdir -p /home/node/.openclaw /home/node/.openclaw/workspace /home/node/.openclaw/workspace/data /home/node/.openclaw/workspace/data/.cache/x-apify /home/node/.cache/ms-playwright
        chown -R node:node /home/node
        chmod 755 /home/node

        cp /tmp/openclaw-seed.json /home/node/.openclaw/openclaw.json
        chmod 600 /home/node/.openclaw/openclaw.json
        if [ -d /tmp/workspace-seed ]; then
          cp -r /tmp/workspace-seed/. /home/node/.openclaw/workspace/ 2>/dev/null || true
        fi

        exec su -s /bin/sh node -c '
          mkdir -p /home/node/.openclaw/browser/openclaw/user-data
          clawhub install typefully --workdir /home/node/.openclaw/workspace 2>/dev/null || true
          (while true; do
            rm -f /home/node/.openclaw/browser/openclaw/user-data/SingletonLock
            chromium --headless=new --no-sandbox --disable-gpu --disable-dev-shm-usage --disable-setuid-sandbox --remote-debugging-port=18800 --user-data-dir=/home/node/.openclaw/browser/openclaw/user-data about:blank >>/tmp/chromium.log 2>&1
            echo "[watchdog] Chromium exited, restarting in 3s..." >>/tmp/chromium.log
            sleep 3
          done) &
          for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
            if wget -q --spider http://127.0.0.1:18800/json/version 2>/dev/null; then
              break
            fi
            sleep 1
          done
          exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
        '

  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:latest
    user: "root"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      BROWSER: echo
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    networks:
      - dokploy-network
    entrypoint: ["node", "dist/index.js"]

volumes:
  openclaw_config:
  openclaw_workspace:
  openclaw_data:

networks:
  dokploy-network:
    external: true
